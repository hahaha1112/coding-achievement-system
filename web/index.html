<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>编程学习成就系统</title>
  <style>
    :root {
      --bg: #f4f7f3;
      --card: #ffffff;
      --ink: #1b2a2f;
      --muted: #5e6c71;
      --line: #d4dfda;
      --accent: #1d7f5a;
      --accent-soft: #dbf2e8;
      --danger: #b2443d;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 85% 0%, #d6efe4 0%, rgba(214, 239, 228, 0) 45%),
        linear-gradient(160deg, #f8fbf7 0%, var(--bg) 55%, #eef5f2 100%);
      min-height: 100vh;
    }

    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      margin: 0;
      font-size: 30px;
      letter-spacing: 0.5px;
    }

    .sub {
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
    }

    .grid {
      margin-top: 18px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(165px, 1fr));
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .label {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 8px;
    }

    .value {
      font-size: 24px;
      font-weight: 700;
    }

    .mission {
      margin-top: 16px;
      background: var(--accent-soft);
      border: 1px solid #b2dbc9;
      border-radius: 14px;
      padding: 14px;
      font-weight: 600;
    }

    .actions {
      margin-top: 18px;
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }

    button {
      border: 1px solid #abd5c3;
      border-radius: 10px;
      background: #f8fffb;
      color: #194f3b;
      font-size: 14px;
      font-weight: 600;
      padding: 12px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(19, 92, 66, .15);
    }

    .status {
      min-height: 24px;
      margin-top: 12px;
      font-size: 14px;
      color: var(--muted);
    }

    .status.error {
      color: var(--danger);
    }

    .achievements {
      margin-top: 18px;
      display: grid;
      gap: 12px;
    }

    .achievement {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #fff;
    }

    .achievement-top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .achievement h3 {
      margin: 0;
      font-size: 16px;
    }

    .tier {
      font-size: 12px;
      font-weight: 700;
      color: var(--accent);
      border: 1px solid #b9dece;
      background: #eff9f4;
      border-radius: 999px;
      padding: 3px 8px;
    }

    .desc {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }

    .bar {
      margin-top: 10px;
      height: 8px;
      background: #edf3f0;
      border-radius: 999px;
      overflow: hidden;
    }

    .bar > span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, #35a06c 0%, #1d7f5a 100%);
      width: 0;
    }

    .meta {
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted);
    }

    @media (max-width: 640px) {
      h1 { font-size: 24px; }
      .wrap { padding: 16px; }
      .value { font-size: 21px; }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>编程学习成就系统</h1>
    <div class="sub">按真实学习行为积累经验值，逐步解锁铜/银/金成就。</div>

    <section class="grid">
      <article class="card">
        <div class="label">等级</div>
        <div class="value" id="level">Lv.1</div>
      </article>
      <article class="card">
        <div class="label">经验值</div>
        <div class="value" id="xp">0</div>
      </article>
      <article class="card">
        <div class="label">连续天数</div>
        <div class="value" id="streak">0</div>
      </article>
      <article class="card">
        <div class="label">累计打卡</div>
        <div class="value" id="checkins">0</div>
      </article>
      <article class="card">
        <div class="label">技能模块</div>
        <div class="value" id="modules">0</div>
      </article>
      <article class="card">
        <div class="label">项目里程碑</div>
        <div class="value" id="projects">0</div>
      </article>
    </section>

    <section class="mission" id="mission">主线任务加载中...</section>

    <section class="actions">
      <button id="checkin-btn">今日打卡（+20 XP）</button>
      <button data-kind="study_hour">学习 1 小时（+15 XP）</button>
      <button data-kind="skill_module">完成 1 个技能模块（+35 XP）</button>
      <button data-kind="project">完成 1 个项目里程碑（+100 XP）</button>
      <button data-kind="bug_fix">解决 1 个 Bug（+25 XP）</button>
      <button data-kind="reflection">写 1 次学习复盘（+20 XP）</button>
      <button data-kind="git_commit">Git 提交 1 次（+8 XP）</button>
    </section>

    <div class="status" id="status"></div>
    <section class="achievements" id="achievements"></section>
  </main>

  <script>
    const statusEl = document.getElementById("status");
    const achievementsEl = document.getElementById("achievements");

    function setStatus(text, isError = false) {
      statusEl.textContent = text;
      statusEl.className = isError ? "status error" : "status";
    }

    async function api(url, options = {}) {
      const res = await fetch(url, options);
      const data = await res.json().catch(() => ({}));
      if (!res.ok) {
        const err = new Error(data.error || "请求失败");
        err.status = res.status;
        throw err;
      }
      return data;
    }

    function render(data) {
      document.getElementById("level").textContent = `Lv.${data.level}`;
      document.getElementById("xp").textContent = `${data.xp} (${data.current_level_xp}/${data.next_level_xp})`;
      document.getElementById("streak").textContent = data.streak;
      document.getElementById("checkins").textContent = data.total_checkins;
      document.getElementById("modules").textContent = data.skill_modules;
      document.getElementById("projects").textContent = data.projects;
      document.getElementById("mission").textContent = data.mission;

      const grouped = data.achievements.reduce((acc, item) => {
        if (!acc[item.category]) acc[item.category] = [];
        acc[item.category].push(item);
        return acc;
      }, {});

      achievementsEl.innerHTML = "";
      Object.keys(grouped).forEach(category => {
        const title = document.createElement("h2");
        title.textContent = `${category}成就`;
        title.style.margin = "6px 0 2px 0";
        title.style.fontSize = "20px";
        achievementsEl.appendChild(title);

        grouped[category].forEach(item => {
          const box = document.createElement("article");
          box.className = "achievement";

          const top = document.createElement("div");
          top.className = "achievement-top";
          top.innerHTML = `
            <h3>${item.name}</h3>
            <span class="tier">${item.tier_name}</span>
          `;
          box.appendChild(top);

          const desc = document.createElement("div");
          desc.className = "desc";
          desc.textContent = item.description;
          box.appendChild(desc);

          const bar = document.createElement("div");
          bar.className = "bar";
          const p = document.createElement("span");
          p.style.width = `${Math.round(item.progress * 100)}%`;
          bar.appendChild(p);
          box.appendChild(bar);

          const meta = document.createElement("div");
          const next = item.next_target === 0 ? "已达成最高级" : `下一档目标: ${item.next_target}`;
          meta.className = "meta";
          meta.textContent = `当前值: ${item.value} | ${next}`;
          box.appendChild(meta);

          achievementsEl.appendChild(box);
        });
      });
    }

    async function refresh() {
      try {
        const data = await api("/api/state");
        render(data);
      } catch (err) {
        setStatus(err.message, true);
      }
    }

    async function performAction(kind) {
      try {
        const data = await api("/api/action", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({kind, amount: 1})
        });
        render(data);
        setStatus("记录成功");
      } catch (err) {
        setStatus(err.message, true);
      }
    }

    document.getElementById("checkin-btn").addEventListener("click", async () => {
      try {
        const data = await api("/api/checkin", {method: "POST"});
        render(data);
        setStatus("打卡成功");
      } catch (err) {
        setStatus(err.message, true);
      }
    });

    document.querySelectorAll("[data-kind]").forEach(btn => {
      btn.addEventListener("click", () => performAction(btn.dataset.kind));
    });

    refresh();
  </script>
</body>
</html>
